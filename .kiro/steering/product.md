---
inclusion: always
---

# YouTube シアターモード拡張機能 - 製品要件

動画プレーヤーの機能を完全に保持しながら、動画以外の要素を暗くして YouTube 視聴体験を向上させる Chrome 拡張機能。

## コア製品要件

**主要機能**: 動画プレーヤーとコントロールの完全な可視性を維持しながら、動画以外の要素（サイドバー、コメント、関連動画）に半透明の暗いオーバーレイを適用する。

**主要機能**:

- ボタンまたはキーボードショートカットでシアターモードを切り替え
- オーバーレイの透明度調整（0-90%）
- YouTube インターフェースとのシームレスな統合
- セッション間での設定の永続化

## 開発制約

**重要な要件**:

- **動画プレーヤーの機能に絶対に干渉しない** - これが最優先事項
- 既存の YouTube キーボードショートカットをすべて保持
- すべての YouTube ページレイアウトと動画タイプをサポート
- 動的コンテンツの読み込みとページナビゲーションに対応
- YouTube のライトテーマとダークテーマの両方をサポート

**パフォーマンス要件**:

- ページ読み込み時間への影響を最小限に抑制
- YouTube の更新で要素検出が破綻した場合の適切な劣化
- 拡張機能が無効化/削除された際の適切なクリーンアップ

## 実装ガイドライン

**要素検出**:

- フォールバックメカニズムを持つ堅牢なセレクターを使用
- 複数の検出戦略を持つ`ElementDetector`クラスを実装
- 特定の YouTube DOM 構造が安定し続けることを前提としない

**状態管理**:

- 設定の信頼できる情報源として`BackgroundService`を使用
- すべてのアクティブな YouTube タブに変更を伝播
- `StorageAdapter`と Chrome Storage API を介して設定を永続化

**エラー処理**:

- すべての例外に`ErrorHandler`を使用
- `Logger`クラスを介した包括的なロギングを実装
- YouTube 機能を破綻させることなく適切に失敗

**通信**:

- コンポーネント通信に`MessageBus`を使用
- ポップアップ、コンテンツスクリプト、バックグラウンドサービス間の確立されたメッセージパッシングパターンに従う

## 品質基準

**譲れない要件**:

- 動画再生やコントロールへの干渉ゼロ
- 異なるブラウザウィンドウサイズでの一貫した動作
- 完全なアクセシビリティ準拠（ARIA 属性、キーボードナビゲーション）
- 通常モードとシアターモード間のスムーズな遷移

**テスト要件**:

- すべての YouTube ページタイプでのテスト（視聴、検索、チャンネルなど）
- キーボードショートカットの保持を検証
- 動的コンテンツシナリオのテスト（自動再生、プレイリストナビゲーション）
- ブラウザセッション間での設定永続性の検証
