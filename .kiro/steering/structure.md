# プロジェクト構造 & アーキテクチャ

## ディレクトリ構造

```
/
├── manifest.json       # 拡張機能マニフェストファイル
├── background.js       # バックグラウンドサービスワーカー
├── content.js          # YouTube ページ用コンテンツスクリプト
├── popup.html          # 拡張機能ポップアップ UI
├── popup.js            # ポップアップ機能
├── popup.css           # ポップアップスタイリング
├── theater-mode.css    # シアターモードオーバーレイのスタイル
├── background-service.js # バックグラウンドサービス機能
├── tab-state-manager.js # タブ状態管理
├── popup-content-communication.js # ポップアップとコンテンツ間の通信
├── test-*.js           # 様々なコンポーネントのテストファイル
├── test-*.html         # HTML テストハーネス
└── run-*-tests.js      # テストランナー
```

## アーキテクチャ概要

この拡張機能は、明確な関心の分離を持つモジュラーアーキテクチャに従っています：

### コアコンポーネント

1. **バックグラウンドサービス** (`background.js`, `background-service.js`)

   - 拡張機能のライフサイクルを管理
   - 設定の保存と取得を処理
   - コンポーネント間の通信を調整
   - 複数の YouTube タブ間でタブ状態を維持

2. **コンテンツスクリプト** (`content.js`)

   - シアターモードオーバーレイを注入・管理
   - YouTube ページ要素を検出
   - キーボードショートカットを処理
   - バックグラウンドサービスと通信

3. **ポップアップ UI** (`popup.html`, `popup.js`, `popup.css`)
   - シアターモードを切り替えるユーザーインターフェースを提供
   - 透明度調整を可能にする
   - 現在の拡張機能の状態を表示
   - バックグラウンドサービスと通信

### 主要クラス

- **TheaterModeController**: シアターモードオーバーレイと切り替え機能を管理
- **ElementDetector**: フォールバックメカニズムを持つ YouTube 要素検出を処理
- **SettingsManager**: ストレージとバリデーションを含むユーザー設定を管理
- **BackgroundService**: 拡張機能の機能を調整
- **TabStateManager**: 複数のタブ間で状態を追跡・同期

## 通信フロー

1. **ユーザーインタラクション**:

   - ユーザーが拡張機能アイコンをクリック → ポップアップが開く
   - ユーザーがシアターモードを切り替え → ポップアップがバックグラウンドにメッセージを送信
   - ユーザーがキーボードショートカットを使用 → コンテンツスクリプトが処理し、バックグラウンドに通知

2. **状態管理**:

   - バックグラウンドサービスが設定の信頼できる情報源を維持
   - 変更はすべてのアクティブな YouTube タブに伝播
   - 設定は Chrome Storage API を使用して永続化

3. **シアターモードの適用**:
   - コンテンツスクリプトが現在の状態に基づいてオーバーレイを適用/削除
   - ユーザー設定に基づいて透明度を調整
   - 動画プレーヤーが完全に表示されたままであることを確認

## テスト戦略

- 個別機能のコンポーネントテスト
- コンポーネント間の通信の統合テスト
- オーバーレイの外観の視覚的テスト
- キーボードショートカットテスト
- 設定永続性テスト
