<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KeyboardShortcutManager テスト</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      h1 {
        color: #333;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
      }
      #results {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        margin-top: 20px;
        white-space: pre-wrap;
        font-family: monospace;
        max-height: 500px;
        overflow-y: auto;
      }
      .success {
        color: #2e7d32;
      }
      .error {
        color: #c62828;
      }
      .shortcut-test {
        margin-top: 30px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .shortcut-test h3 {
        margin-top: 0;
      }
      .test-input {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 100%;
        margin-bottom: 10px;
      }
      .test-button {
        padding: 8px 16px;
        background-color: #4285f4;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .test-button:hover {
        background-color: #3367d6;
      }
    </style>
  </head>
  <body>
    <h1>KeyboardShortcutManager テスト</h1>
    <p>このページは KeyboardShortcutManager クラスの単体テストを実行します。</p>
    <p>テスト結果はコンソールに出力されます。</p>

    <div id="results">テスト実行中...</div>

    <div class="shortcut-test">
      <h3>ショートカットの手動テスト</h3>
      <p>
        以下のテキストボックスにフォーカスを当て、ショートカットを試してください：
      </p>
      <ul>
        <li><strong>Ctrl+Shift+T</strong>: シアターモード切替</li>
        <li><strong>Ctrl+Shift+↑</strong>: 透明度を上げる</li>
        <li><strong>Ctrl+Shift+↓</strong>: 透明度を下げる</li>
      </ul>
      <input
        type="text"
        class="test-input"
        placeholder="ここにフォーカスを当ててショートカットを試してください"
      />
      <div id="shortcut-result">ショートカットの結果がここに表示されます</div>
    </div>

    <!-- 依存ライブラリ -->
    <script src="../infrastructure/logger.js"></script>
    <script src="../infrastructure/error-handler.js"></script>
    <script src="../infrastructure/state-store.js"></script>

    <!-- テスト対象 -->
    <script src="../keyboard-shortcut-manager.js"></script>

    <!-- テストスクリプト -->
    <script src="./test-keyboard-shortcuts.js"></script>

    <script>
      // コンソール出力をキャプチャしてページに表示
      const resultsDiv = document.getElementById("results");
      const shortcutResultDiv = document.getElementById("shortcut-result");
      const originalConsole = {
        log: console.log,
        error: console.error,
        warn: console.warn,
        assert: console.assert,
      };

      let testOutput = "";

      console.log = function (...args) {
        originalConsole.log(...args);
        testOutput += args.join(" ") + "\n";
        resultsDiv.textContent = testOutput;
      };

      console.error = function (...args) {
        originalConsole.error(...args);
        testOutput += "❌ ERROR: " + args.join(" ") + "\n";
        resultsDiv.textContent = testOutput;
        resultsDiv.classList.add("error");
      };

      console.warn = function (...args) {
        originalConsole.warn(...args);
        testOutput += "⚠️ WARNING: " + args.join(" ") + "\n";
        resultsDiv.textContent = testOutput;
      };

      console.assert = function (condition, ...args) {
        if (!condition) {
          originalConsole.assert(condition, ...args);
          testOutput += "❌ ASSERTION FAILED: " + args.join(" ") + "\n";
          resultsDiv.textContent = testOutput;
          resultsDiv.classList.add("error");
        }
      };

      // 手動テスト用のショートカットマネージャー
      window.addEventListener("load", function () {
        // 自動テスト完了時の処理
        setTimeout(function () {
          if (!testOutput.includes("FAILED") && !testOutput.includes("ERROR")) {
            resultsDiv.classList.add("success");
            testOutput += "\n✅ All tests completed successfully!";
            resultsDiv.textContent = testOutput;
          }

          // 手動テスト用のマネージャーをセットアップ
          setupManualTest();
        }, 1000);
      });

      function setupManualTest() {
        // ActionCreator モック
        window.ActionCreator = {
          toggleTheaterMode: () => ({ type: "THEATER_MODE_TOGGLE" }),
          updateOpacity: (opacity) => ({
            type: "OPACITY_UPDATE",
            payload: { opacity },
          }),
        };

        // ロガーモック
        const logger = {
          debug: (...args) => originalConsole.log("[DEBUG]", ...args),
          info: (...args) => originalConsole.log("[INFO]", ...args),
          warn: (...args) => originalConsole.log("[WARN]", ...args),
          error: (...args) => originalConsole.log("[ERROR]", ...args),
        };

        // エラーハンドラーモック
        const errorHandler = {
          wrapSync: (fn) => {
            try {
              const result = fn();
              return {
                isSuccess: () => true,
                isFailure: () => false,
                data: result,
              };
            } catch (error) {
              return { isSuccess: () => false, isFailure: () => true, error };
            }
          },
          wrapAsync: (fn) => {
            return Promise.resolve(fn())
              .then((result) => ({
                isSuccess: () => true,
                isFailure: () => false,
                data: result,
              }))
              .catch((error) => ({
                isSuccess: () => false,
                isFailure: () => true,
                error,
              }));
          },
        };

        // 状態ストアモック
        const stateStore = {
          state: {
            theaterMode: {
              isEnabled: false,
              opacity: 0.7,
            },
          },
          getState: function () {
            return this.state;
          },
          getStateValue: function (path, defaultValue) {
            const parts = path.split(".");
            let value = this.state;

            for (const part of parts) {
              if (value === undefined || value === null) {
                return defaultValue;
              }
              value = value[part];
            }

            return value !== undefined ? value : defaultValue;
          },
          subscribeToPath: function () {
            return () => {};
          },
          dispatch: function (action) {
            shortcutResultDiv.textContent = `アクション実行: ${JSON.stringify(
              action
            )}`;

            if (action.type === "THEATER_MODE_TOGGLE") {
              this.state.theaterMode.isEnabled =
                !this.state.theaterMode.isEnabled;
              shortcutResultDiv.textContent += `\nシアターモード: ${
                this.state.theaterMode.isEnabled ? "ON" : "OFF"
              }`;
            } else if (action.type === "OPACITY_UPDATE") {
              this.state.theaterMode.opacity = action.payload.opacity;
              shortcutResultDiv.textContent += `\n透明度: ${Math.round(
                this.state.theaterMode.opacity * 100
              )}%`;
            }

            return {
              isSuccess: () => true,
              isFailure: () => false,
              data: this.state,
            };
          },
        };

        // キーボードショートカットマネージャーを作成
        const manager = new KeyboardShortcutManager({
          logger,
          errorHandler,
          stateStore,
        });

        // 初期化
        manager.initialize().then(() => {
          shortcutResultDiv.textContent =
            "ショートカットマネージャーが初期化されました。ショートカットを試してください。";
        });
      }
    </script>
  </body>
</html>
