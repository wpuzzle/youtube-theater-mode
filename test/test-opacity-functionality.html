<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpacityController テスト</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      h1 {
        color: #333;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
      }
      #results {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        margin-top: 20px;
        white-space: pre-wrap;
        font-family: monospace;
        max-height: 500px;
        overflow-y: auto;
      }
      .success {
        color: #2e7d32;
      }
      .error {
        color: #c62828;
      }
      .demo-area {
        margin-top: 30px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .demo-area h3 {
        margin-top: 0;
      }
      .demo-box {
        width: 100%;
        height: 200px;
        background-color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        position: relative;
        overflow: hidden;
      }
      .demo-content {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("https://via.placeholder.com/800x400/333333/FFFFFF?text=Background+Content");
        background-size: cover;
        z-index: 1;
      }
      .demo-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, var(--demo-opacity));
        z-index: 2;
        transition: background-color 0.3s ease;
      }
      .demo-text {
        position: relative;
        z-index: 3;
      }
      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }
      .control-button {
        padding: 8px 16px;
        background-color: #4285f4;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .control-button:hover {
        background-color: #3367d6;
      }
      .opacity-value {
        font-weight: bold;
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <h1>OpacityController テスト</h1>
    <p>このページは OpacityController クラスの単体テストを実行します。</p>
    <p>テスト結果はコンソールに出力されます。</p>

    <div id="results">テスト実行中...</div>

    <div class="demo-area">
      <h3>透明度デモ</h3>
      <p>以下のコントロールを使用して透明度を調整できます：</p>

      <div class="controls">
        <button id="decrease" class="control-button">
          透明度を下げる (-10%)
        </button>
        <button id="increase" class="control-button">
          透明度を上げる (+10%)
        </button>
        <button id="reset" class="control-button">リセット (70%)</button>
        <span class="opacity-value"
          >現在の透明度: <span id="opacity-value">70%</span></span
        >
      </div>

      <div class="demo-box">
        <div class="demo-content"></div>
        <div class="demo-overlay"></div>
        <div class="demo-text">オーバーレイ透明度デモ</div>
      </div>
    </div>

    <!-- 依存ライブラリ -->
    <script src="../infrastructure/logger.js"></script>
    <script src="../infrastructure/error-handler.js"></script>
    <script src="../infrastructure/state-store.js"></script>

    <!-- テスト対象 -->
    <script src="../opacity-controller.js"></script>

    <!-- テストスクリプト -->
    <script src="./test-opacity-functionality.js"></script>

    <script>
      // コンソール出力をキャプチャしてページに表示
      const resultsDiv = document.getElementById("results");
      const originalConsole = {
        log: console.log,
        error: console.error,
        warn: console.warn,
        assert: console.assert,
      };

      let testOutput = "";

      console.log = function (...args) {
        originalConsole.log(...args);
        testOutput += args.join(" ") + "\n";
        resultsDiv.textContent = testOutput;
      };

      console.error = function (...args) {
        originalConsole.error(...args);
        testOutput += "❌ ERROR: " + args.join(" ") + "\n";
        resultsDiv.textContent = testOutput;
        resultsDiv.classList.add("error");
      };

      console.warn = function (...args) {
        originalConsole.warn(...args);
        testOutput += "⚠️ WARNING: " + args.join(" ") + "\n";
        resultsDiv.textContent = testOutput;
      };

      console.assert = function (condition, ...args) {
        if (!condition) {
          originalConsole.assert(condition, ...args);
          testOutput += "❌ ASSERTION FAILED: " + args.join(" ") + "\n";
          resultsDiv.textContent = testOutput;
          resultsDiv.classList.add("error");
        }
      };

      // デモ用のコントローラー
      window.addEventListener("load", function () {
        // 自動テスト完了時の処理
        setTimeout(function () {
          if (!testOutput.includes("FAILED") && !testOutput.includes("ERROR")) {
            resultsDiv.classList.add("success");
            testOutput += "\n✅ All tests completed successfully!";
            resultsDiv.textContent = testOutput;
          }

          // デモ用のコントローラーをセットアップ
          setupDemo();
        }, 1000);
      });

      function setupDemo() {
        // ActionCreator モック
        window.ActionCreator = {
          updateOpacity: (opacity) => ({
            type: "OPACITY_UPDATE",
            payload: { opacity },
          }),
        };

        // ロガーモック
        const logger = {
          debug: (...args) => originalConsole.log("[DEBUG]", ...args),
          info: (...args) => originalConsole.log("[INFO]", ...args),
          warn: (...args) => originalConsole.log("[WARN]", ...args),
          error: (...args) => originalConsole.log("[ERROR]", ...args),
        };

        // エラーハンドラーモック
        const errorHandler = {
          wrapSync: (fn) => {
            try {
              const result = fn();
              return {
                isSuccess: () => true,
                isFailure: () => false,
                data: result,
              };
            } catch (error) {
              return { isSuccess: () => false, isFailure: () => true, error };
            }
          },
          wrapAsync: (fn) => {
            return Promise.resolve(fn())
              .then((result) => ({
                isSuccess: () => true,
                isFailure: () => false,
                data: result,
              }))
              .catch((error) => ({
                isSuccess: () => false,
                isFailure: () => true,
                error,
              }));
          },
        };

        // 透明度コントローラーを作成
        const controller = new OpacityController({ logger, errorHandler });
        controller.initialize();

        // デモ要素
        const demoOverlay = document.querySelector(".demo-overlay");
        const opacityValue = document.getElementById("opacity-value");

        // 初期値を設定
        document.documentElement.style.setProperty(
          "--demo-opacity",
          controller.currentOpacity
        );
        updateOpacityDisplay(controller.currentOpacity);

        // ボタンイベントを設定
        document.getElementById("decrease").addEventListener("click", () => {
          const result = controller.decreaseOpacity();
          if (result.isSuccess()) {
            document.documentElement.style.setProperty(
              "--demo-opacity",
              controller.currentOpacity
            );
            updateOpacityDisplay(controller.currentOpacity);
          }
        });

        document.getElementById("increase").addEventListener("click", () => {
          const result = controller.increaseOpacity();
          if (result.isSuccess()) {
            document.documentElement.style.setProperty(
              "--demo-opacity",
              controller.currentOpacity
            );
            updateOpacityDisplay(controller.currentOpacity);
          }
        });

        document.getElementById("reset").addEventListener("click", () => {
          const result = controller.resetOpacity();
          if (result.isSuccess()) {
            document.documentElement.style.setProperty(
              "--demo-opacity",
              controller.currentOpacity
            );
            updateOpacityDisplay(controller.currentOpacity);
          }
        });

        function updateOpacityDisplay(opacity) {
          opacityValue.textContent = `${Math.round(opacity * 100)}%`;
        }
      }
    </script>
  </body>
</html>
